<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sample Sign Out</title>

<style>
* { box-sizing: border-box; font-family: system-ui, sans-serif; }
body { margin: 0; background: #f5f5f5; display: flex; justify-content: center; }
.container { width: 100%; max-width: 420px; background: #fff; padding: 20px; min-height: 100vh; }
h1 { text-align: center; }

.hidden { display: none; }

input, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  font-size: 16px;
}

button {
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.primary { background: #007bff; color: #fff; }
.secondary { background: #ddd; }
.danger { background: #dc3545; color: #fff; }

.result, .cart-item {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
}

.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.remove {
  color: red;
  cursor: pointer;
  font-weight: bold;
}
</style>
</head>

<body>
<div class="container">

<!-- HOME PAGE -->
<div id="homePage">
  <h1>Sample Management</h1>
  <button class="primary" onclick="goToInfo()">Sign Samples Out</button>
  <button class="secondary" disabled>Check In Samples</button>
</div>

<!-- CUSTOMER INFO PAGE -->
<div id="infoPage" class="hidden">
  <h1>Customer Info</h1>

  <input id="customerName" placeholder="Customer Name">
  <input id="customerNumber" placeholder="Customer Number">
  <input id="employeeName" placeholder="Employee Name">

  <button class="primary" onclick="proceed()">Proceed</button>
  <button class="secondary" onclick="goHome()">Back</button>
</div>

<!-- SEARCH & CART PAGE -->
<div id="searchPage" class="hidden">
  <h1>Search Samples</h1>

  <input id="barcodeInput" placeholder="Enter Barcode">
  <button class="primary" onclick="searchBarcode()">Search</button>

  <div id="results"></div>

  <h3>Cart</h3>
  <div id="cart"></div>

  <button class="primary" onclick="signOut()">Sign Out</button>
  <button class="secondary" onclick="goHome()">Home</button>
</div>

</div>

<script>
// ---------- STATE ----------
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfj3z1TuTx1GhU_CNO0rMSuROaNVx5c7fGhwebd-Znv7b8dbFMuioHFl8yB1PkLwZheQ/exec";

let customerInfo = {};
let cart = [];

// ---------- ELEMENTS ----------
const homePage = document.getElementById("homePage");
const infoPage = document.getElementById("infoPage");
const searchPage = document.getElementById("searchPage");
const resultsDiv = document.getElementById("results");
const cartDiv = document.getElementById("cart");
const customerNameInput = document.getElementById("customerName");
const customerNumberInput = document.getElementById("customerNumber");
const employeeNameInput = document.getElementById("employeeName");
const barcodeInput = document.getElementById("barcodeInput");

// ---------- NAVIGATION ----------
function goToInfo() {
  homePage.classList.add("hidden");
  infoPage.classList.remove("hidden");
}

function goHome() {
  // Hide all pages except home
  infoPage.classList.add("hidden");
  searchPage.classList.add("hidden");
  homePage.classList.remove("hidden");

  // Clear all form fields and cart
  customerNameInput.value = "";
  customerNumberInput.value = "";
  employeeNameInput.value = "";
  barcodeInput.value = "";
  resultsDiv.innerHTML = "";
  cart = [];
  renderCart();
}

// ---------- PROCEED ----------
function proceed() {
  const name = customerNameInput.value.trim();
  const number = customerNumberInput.value.trim();
  const employee = employeeNameInput.value.trim();

  if (!name || !number || !employee) {
    alert("Please fill all fields.");
    return;
  }

  // Store customer info
  customerInfo = { name, number, employee };

  // Move to search page
  infoPage.classList.add("hidden");
  searchPage.classList.remove("hidden");
}

// ---------- SEARCH ----------
async function searchBarcode() {
  const barcode = barcodeInput.value.trim();
  if (!barcode) return;

  resultsDiv.innerHTML = "Searching...";

  try {
    const res = await fetch(`${SCRIPT_URL}?action=search&barcode=${barcode}`);
    const data = await res.json();

    resultsDiv.innerHTML = "";

    if (data.length === 0) {
      resultsDiv.innerHTML = "<em>No items found for this barcode.</em>";
      return;
    }

    resultsDiv.innerHTML = ""; // clear previous results

	data.forEach(item => {
  	// Create container for each result
  	const div = document.createElement("div");
 	div.className = "result";
  	div.innerHTML = `<strong>${item}</strong>`; // just show item name

  	// Create the "Add Sample" button
  	const btn = document.createElement("button");
  	btn.textContent = "Add Sample";
  	btn.className = "primary";

  	// Attach event listener safely
  	btn.addEventListener("click", () => addToCart(item));

  	div.appendChild(btn);
  	resultsDiv.appendChild(div);
	});

  } catch (err) {
    resultsDiv.innerHTML = "<em>Error searching barcode.</em>";
    console.error(err);
  }
}

// ---------- CART ----------
function addToCart(item) {
  if (!cart.includes(item)) {
    // Inside search result click handler
	cart.push({ barcode: result.barcode, name: result.name });
	renderCart();

  }
  // Clear search
  barcodeInput.value = "";
  resultsDiv.innerHTML = "";
}

function removeFromCart(item) {
  cart = cart.filter(i => i !== item);
  renderCart();
}

function renderCart() {
  cartDiv.innerHTML = "";
  cart.forEach(item => {
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `
      ${item} <span class="remove" onclick="removeFromCart('${item}')">âœ•</span>
    `;
    cartDiv.appendChild(div);
  });
}

// ---------- SIGN OUT ----------
async function signOut() {
  if (!cart.length) {
    alert("Cart is empty.");
    return;
  }

  // Collect customer info
  const customerInfo = {
    name: document.getElementById("customerName").value.trim(),
    number: document.getElementById("customerNumber").value.trim(),
    employee: document.getElementById("employeeName").value.trim()
  };

  if (!customerInfo.name || !customerInfo.number || !customerInfo.employee) {
    alert("Please fill in all customer information before signing out.");
    return;
  }

  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "signout",
        customerInfo,
        items: cart.map(item => ({ barcode: item.barcode, name: item.name }))
      })
    });

    alert("Samples signed out successfully!");

    // Clear cart and inputs for next customer
    cart = [];
    renderCart(); // if you have a function to display the cart
    document.getElementById("customerName").value = "";
    document.getElementById("customerNumber").value = "";
    document.getElementById("employeeName").value = "";
    document.getElementById("barcodeInput").value = "";
    document.getElementById("resultsDiv").innerHTML = "";
  } catch (err) {
    console.error(err);
    alert("Error signing out samples.");
  }
}
</script>
</body>
</html>
