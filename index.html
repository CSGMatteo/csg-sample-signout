<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sample Sign Out</title>

<style>
* { box-sizing: border-box; font-family: system-ui, sans-serif; }
body { margin: 0; background: #f5f5f5; display: flex; justify-content: center; }
.container { width: 100%; max-width: 420px; background: #fff; padding: 20px; min-height: 100vh; }
h1 { text-align: center; }

.hidden { display: none; }

input, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  font-size: 16px;
}

button {
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.primary { background: #007bff; color: #fff; }
.secondary { background: #ddd; }
.danger { background: #dc3545; color: #fff; }

.result, .cart-item {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
}

.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.remove {
  color: red;
  cursor: pointer;
  font-weight: bold;
}
</style>
</head>

<body>
<div class="container">

<!-- HOME PAGE -->
<div id="homePage">
  <h1>Sample Management</h1>
  <button class="primary" onclick="goToInfo()">Sign Samples Out</button>
  <button class="secondary" disabled>Check In Samples</button>
</div>

<!-- CUSTOMER INFO PAGE -->
<div id="infoPage" class="hidden">
  <h1>Customer Info</h1>

  <input id="customerName" placeholder="Customer Name">
  <input id="customerNumber" placeholder="Customer Number">
  <input id="employeeName" placeholder="Employee Name">

  <button class="primary" onclick="proceed()">Proceed</button>
  <button class="secondary" onclick="goHome()">Back</button>
</div>

<!-- SEARCH & CART PAGE -->
<div id="searchPage" class="hidden">
  <h1>Search Samples</h1>

  <input id="barcodeInput" placeholder="Enter Barcode">
  <button class="primary" onclick="searchBarcode()">Search</button>

  <div id="results"></div>

  <h3>Cart</h3>
  <div id="cart"></div>

  <button class="primary" onclick="signOut()">Sign Out</button>
  <button class="secondary" onclick="goHome()">Home</button>
</div>

</div>

<script>
// ---------- CONFIG ----------
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxueyEwovdm7hcVa3BWhzQw8_ZH4NZHerUqEzeido13sPDUtRN1kqK9r3nM-89aP7XBog/exec"; // replace with your Apps Script URL

// ---------- STATE ----------
let customerInfo = {};
let cart = [];

// ---------- ELEMENTS ----------
const homePage = document.getElementById("homePage");
const infoPage = document.getElementById("infoPage");
const searchPage = document.getElementById("searchPage");
const resultsDiv = document.getElementById("results");
const cartDiv = document.getElementById("cart");
const customerNameInput = document.getElementById("customerName");
const customerNumberInput = document.getElementById("customerNumber");
const employeeNameInput = document.getElementById("employeeName");
const barcodeInput = document.getElementById("barcodeInput");

// ---------- NAVIGATION ----------
function goToInfo() {
  homePage.classList.add("hidden");
  infoPage.classList.remove("hidden");
}

function goHome() {
  infoPage.classList.add("hidden");
  searchPage.classList.add("hidden");
  homePage.classList.remove("hidden");

  // Clear all fields
  customerNameInput.value = "";
  customerNumberInput.value = "";
  employeeNameInput.value = "";
  barcodeInput.value = "";
  resultsDiv.innerHTML = "";
  cart = [];
  renderCart();
}

// ---------- PROCEED ----------
function proceed() {
  const name = customerNameInput.value.trim();
  const number = customerNumberInput.value.trim();
  const employee = employeeNameInput.value.trim();

  if (!name || !number || !employee) {
    alert("Please fill all fields.");
    return;
  }

  customerInfo = { name, number, employee };

  infoPage.classList.add("hidden");
  searchPage.classList.remove("hidden");
}

// ---------- SEARCH ----------
async function searchBarcode() {
  const barcode = barcodeInput.value.trim();
  if (!barcode) return;

  resultsDiv.innerHTML = "Searching...";

  try {
    const res = await fetch(`${SCRIPT_URL}?action=search&barcode=${barcode}`);
    const data = await res.json();

    resultsDiv.innerHTML = "";

    if (!data || data.length === 0) {
      resultsDiv.innerHTML = "<em>No items found for this barcode.</em>";
      return;
    }

    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "result";

      div.innerHTML = `<strong>${item.name}</strong> (Barcode: ${item.barcode})`;

      const btn = document.createElement("button");
      btn.textContent = "Add Sample";
      btn.className = "primary";

      btn.addEventListener("click", () => addToCart(item));

      div.appendChild(btn);
      resultsDiv.appendChild(div);
    });

  } catch (err) {
    resultsDiv.innerHTML = "<em>Error searching barcode.</em>";
    console.error(err);
  }
}

// ---------- CART ----------
function addToCart(item) {
  if (!cart.some(i => i.barcode === item.barcode && i.name === item.name)) {
    cart.push({ barcode: item.barcode, name: item.name });
    renderCart();
  }

  barcodeInput.value = "";
  resultsDiv.innerHTML = "";
}

function removeFromCart(itemIndex) {
  cart.splice(itemIndex, 1);
  renderCart();
}

function renderCart() {
  cartDiv.innerHTML = "";
  cart.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `
      ${item.name} (Barcode: ${item.barcode})
      <span class="remove" onclick="removeFromCart(${index})">âœ•</span>
    `;
    cartDiv.appendChild(div);
  });
}

// ---------- SIGN OUT ----------
async function signOut() {
  if (!cart.length) {
    alert("Cart is empty.");
    return;
  }

  const customerInfoData = {
    name: customerNameInput.value.trim(),
    number: customerNumberInput.value.trim(),
    employee: employeeNameInput.value.trim()
  };

  if (!customerInfoData.name || !customerInfoData.number || !customerInfoData.employee) {
    alert("Please fill in all customer information before signing out.");
    return;
  }

  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "signout",
        customerInfo: customerInfoData,
        items: cart
      })
    });

    alert("Samples signed out successfully!");

    // Reset
    cart = [];
    renderCart();
    customerNameInput.value = "";
    customerNumberInput.value = "";
    employeeNameInput.value = "";
    barcodeInput.value = "";
    resultsDiv.innerHTML = "";

  } catch (err) {
    console.error(err);
    alert("Error signing out samples.");
  }
}
</script>
</body>
</html>
